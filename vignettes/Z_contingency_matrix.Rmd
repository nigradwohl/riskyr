---
title: "Contingency Matrix"
author: "SPDS, uni.kn"
date: "2018 04 16"
output: 
  rmarkdown::html_vignette: 
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Confusion Matrix and Metrics}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library("riskyr")  # load the "riskyr" package
```

## Goal

Generalize the 2x2 confusion matrix (framed in the semantics of SDT and clinical diagnostics) to different types of contingency tables (e.g., to also represent effects of treatments, RCTs, or preventive measures). 

## Terminology

The following "contingency matrix"" is a generalization of the "confusion matrix":

|              | 'cols' |          |       |          |        |       
| ------------:  |:--------:|:--------:|:--------:|:--:|:---------:|              
| `rows` | c1 (`TRUE`):      | c2 (`FALSE`):     |     Sum:  |  (b) column 1 by row: |  (b) column 2 by row | 
| r1 (`TRUE`):      | `r1c1`  | `r1c2`         | `n_r1` | `pr_r1c1` = `r1c1`/`r1`  | `pr_r1c2` = `r1c2`/`r1` |
| r2 (`FALSE`):  | `r2c1`  | `r2c2`         | `n_r2` | `pr_r2c1` = `r2c1`/`r2`     | `pr_r2c2` = `r2c2`/`r2` |
|      Sum:          | `n_c1`   | `n_c2`          | `N`   | `p_c1` =  `n_c1`/`N`     | `p_c2` =  `n_c2`/`N` |
| (a) row 1 by column | `pc_r1c1` = `r1c1`/`c1` | `pc_r1c2` = `r1c2`/`c2` | `p_r1` = `n_r1`/`N` |  `rc12` = `diag`/`N` = (`r1c1`+`r2c2`)/`N`|
| (a) row 2 by column | `pc_r2c1` = `r2`/`c1` | `pc_r2c2` = `r2c2`/`c2` | `p_r2` = `n_r2`/`N` | | |


The following properties hold for this table: 

* For frequencies, (i.e., the inner three rows and columns):
    + if at least any two entries in a row or column are provided, all values in _this_ row or column can be
    calculated. 
    + As soon, as there are three values in one row or column, there is redundancy, and more input is needed. 
    + At least three different cells need to be in a row or column with two filled cells in this row or column 
    (kind of an s-shape). 
    
  This can be used to test frequency entries for completeness. 

* For probabilities (N is normed to 1):
    + probabilities in one row or column are not independent, and thus do not add up to 1. 
    + The probabilities derived from the margins (unconditional probabilities p_c1, p_r1 and their inverse) 
    add up to 1. 
    
    + probabilities obey a 2x2 table for N = 1.  This table can be multiplied by any N to obtain frequencies. 
    + As they are probabilities N is known to be 1 by __definition__. 
    + The probabilities seem to be non-redundant, if three cells can be calculated directly from the input (just 
    as with frequencies) 
    + This only holds for cell probabilities; not for the conditional ones; it seems to reproduce Bayes' theorem 
    in a sense 
    + This tells us that one cell probability (p(A&B)) and two unconditional probabilities can be sufficient 
    (e.g., n_c1, N, p_r1, P_c1, should suffice).  this is also the case, if instead of one cell frequency a 
    conditional probability is provided (as then the cell frequency can be computed from N, and the cell 
    probability can be calculated). 


Note that the probabilities in the margins follow `nrow_prob == nrow_freq - 1` and `ncol_prob == ncol_freq - 1` (ignoring cases with partial cell sums like `r1c1 + r1c2 / r1c1 + r1c2 + r1c3`). 

## Use R-code to create the respecitve input-table (label-tabels):

Create frequency table: 

```{r create_terminology_matrix_freq}
## define rows with frequencies (table extent), example 2x2:
n_row <- 2
n_col <- 2

# get the single frequencies:
row_lab <- paste0("r", 1:n_row)
col_lab <- paste0("c", 1:n_col)

freq_labs <- expand.grid(row_lab, col_lab)
freq_mat <- matrix(paste0(freq_labs[, 1], freq_labs[, 2]), ncol = n_col, nrow = n_row)

# get labels for the sums:
rowsum_lab <- paste0("n_r", 1:n_row)
colsum_lab <- c(paste0("n_c", 1:n_col), "N")  # add N in the end. 

## (1) Assemble prelimnary table:
freq_mat <- cbind(freq_mat, rowsum_lab, deparse.level = 0)
freq_mat <- rbind(freq_mat, colsum_lab, deparse.level = 0)
freq_mat

## (2) Adding the probabilities:
```

Showing the table as `kable`

```{r show_table_freq, results='asis'}
colnames(freq_mat) <- c(paste0("col", 1:n_col), "Sum")
rownames(freq_mat) <- c(paste0("row", 1:n_row), "Sum")
  
knitr::kable(freq_mat)
```


Showing the table as figure 

```{r show_table_freq_fig}

## Get plot dimensions: 
plot_dim <- dim(freq_mat) + 1

## Initialize plot of respective size: 
plot(x = 1, xlim = c(-1, plot_dim[1] + 1), ylim = c(-1, plot_dim[2] + 1),
     type = "n")

## Get coordinates
coords <- expand.grid(x = 1:plot_dim[1], y = plot_dim[2]:1)

entries <- c("", colnames(freq_mat),
             unlist(freq_mat)
             )
```


## OLDER MATERIALS


## Confusion Matrix

|              | Condition |          |       |          |            
| ----------:  |:--------:|:--------:|:--------:|:--------:|              
| **Decision** | present (`TRUE`):      | absent (`FALSE`):     |     Sum:  |  (b) by decision: |  
| positive (`TRUE`):   | `hi`         | `fa`         | `dec.pos` | `PPV` = `hi`/`dec.pos` |
| negative (`FALSE`):  | `mi`         | `cr`         | `dec.neg` | `NPV` = `cr`/`dec.neg` |
|      Sum:    | `cond.true`  | `cond.false` |       `N` |         `prev` =  `cond.true`/`N`     |
| (a) by condition  | `sens` = `hi`/`cond.true` | `spec` = `cr`/`cond.false` | `ppod` = `dec.pos`/`N` |  `acc` = `dec.cor`/`N` = (`hi`+`cr`)/`N` |



## References

Links to related Wikipedia articles:

- [Confusion matrix](https://en.wikipedia.org/wiki/Confusion_matrix) (URL: https://en.wikipedia.org/wiki/Confusion_matrix)



## Contact

<!-- uni.kn logo and link to SPDS: -->  
<!-- ![](./inst/pix/uniKn_logo.png) --> 
<a href="https://www.spds.uni-konstanz.de/">
<img src = "../inst/pix/uniKn_logo.png" alt = "spds.uni.kn" style = "width: 280px; float: right; border:10;"/> 
<!--<img src = "../inst/pix/uniKn_logo_s.png" alt = "spds.uni.kn" style = "float: right; border:10;"/> --> 
</a>

We appreciate your feedback, comments, or questions. 

- Please report any `riskyr`-related issues at <https://github.com/hneth/riskyr/issues>.

- For general inquiries, please email us at <contact.riskyr@gmail.com>. 


## All `riskyr` Vignettes

<!-- riskyr logo: -->
<a href="https://github.com/hneth/riskyr">
<img src="../inst/pix/riskyr_cube.png" alt="riskyr" style="width: 125px; float: right; border:10;"/>
</a>

<!-- Index of vignettes: -->

| Nr.  | Vignette | Content    |        
| ---: |:---------|:-----------|
| A. | [User guide](A_user_guide.html) | Motivation and general instructions | 
| B. | [Data formats](B_data_formats.html) | Data formats: Frequencies and probabilities | 
| C. | [Confusion matrix](C_confusion_matrix.html) | Confusion matrix and accuracy metrics |
| D. | [Functional perspectives](D_functional_perspectives.html) | Adopting functional perspectives |
| E. | [Quick start primer](E_riskyr_primer.html) | Quick start primer |

<!-- eof. -->
